<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>HomeFloorPlan</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Ubuntu+Condensed&family=Ubuntu+Mono:ital,wght@0,400;0,700;1,400;1,700&family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap"
      rel="stylesheet"
    />

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background: #fafafa;
      }
      svg {
        width: 100vw;
        height: 100vh;
        display: block;
      }

      .sensor-g.sensor-temp_inside {
        font-size: 128px;
        text-shadow: 4px 4px 4px black;
      }
      .sensor-g.sensor-temp_outside {
        font-size: 128px;
        text-shadow: 4px 4px 4px black;
      }
      .sensor-g.sensor-temp_sun {
        font-size: 64px;
        text-shadow: 2px 2px 2px black;
      }
      .sensor-g.sensor-simple_window {
        font-size: 52px;
        text-shadow: 2px 2px 2px black;
      }


      .sensor-d.sensor-temp_inside {
        font-size: 48px;
        text-shadow: 2px 2px 2px black;
      }
      .sensor-d.sensor-temp_outside {
        font-size: 48px;
        text-shadow: 2px 2px 2px black;
      }
      .sensor-d.sensor-temp_sun {
        font-size: 36px;
        text-shadow: 1px 1px 1px black;
      }
      .sensor-d.sensor-co2 {
        font-size: 36px;
        text-shadow: 1px 1px 1px black;
      }
      .sensor-d.sensor-simple_window {
        font-size: 52px;
        text-shadow: 2px 2px 2px black;
      }

      .sensor-value {
        font-family: "Ubuntu Mono", monospace;
        font-weight: bold;
        pointer-events: none;
        user-select: none;
        white-space: pre;
      }

      button {
        font-family: "Ubuntu Mono", monospace;
        font-weight: bold;
        font-size: 32px;
      }
    </style>
  </head>
  <body>
  <button onclick="showGeneralSensors()">Show General Sensors</button>
  <button onclick="showDetailedSensors()">Show Detailed Sensors</button>
  <br />
    <svg
      id="floorplan"
      viewBox="-150 -200 1150 2000"
      preserveAspectRatio="xMidYMid meet"
    >
      <g id="viewport"></g>
    </svg>

    <script>
      let sensorDefs = {};
      //const path = "../example_data/";
      const path="../../HomeFloorMapDATA/";
      const sensorClassesG = {
        temp_inside: {
          unit: "",
          precision: 0,
          length: 2,
          colorScale: d3
            .scaleThreshold()
            .domain([20, 22, 24, 26, 28])
            .range([
              "#0087bd",
              "#009698",
              "#008000",
              "#eed202",
              "#ff4500",
              "#ff0800",
            ]),
        },
        temp_outside: {
          /* TODO: take care of winter */ unit: "°C",
          precision: 0,
          length: 3,
          colorScale: d3
            .scaleThreshold()
            .domain([16, 20, 24, 26, 28, 30])
            .range([
              "#0087bd",
              "#009698",
              "#008000",
              "#eed202",
              "#ff4500",
              "#ff0800",
            ]),
        },
        temp_sun: {
          /* TODO: take care of winter */ unit: "°C",
          precision: 0,
          length: 3,
          colorScale: d3
            .scaleThreshold()
            .domain([18, 22, 26, 28, 30, 32])
            .range([
              "#0087bd",
              "#009698",
              "#008000",
              "#eed202",
              "#ff4500",
              "#ff0800",
            ]),
        },
        simple_window: {
        },
      };
      const sensorClassesD = {
        temp_inside: {
          unit: "°C",
          precision: 1,
          length: 4,
          colorScale: d3
            .scaleThreshold()
            .domain([20, 22, 24, 26, 28])
            .range([
              "#0087bd",
              "#009698",
              "#008000",
              "#eed202",
              "#ff4500",
              "#ff0800",
            ]),
        },
        temp_outside: {
          /* TODO: take care of winter */
          unit: "°C",
          precision: 1,
          length: 5,
          colorScale: d3
            .scaleThreshold()
            .domain([16, 20, 24, 26, 28, 30])
            .range([
              "#0087bd",
              "#009698",
              "#008000",
              "#eed202",
              "#ff4500",
              "#ff0800",
            ]),
        },
        temp_sun: {
          /* TODO: take care of winter */
          unit: "°C",
          precision: 1,
          length: 5,
          colorScale: d3
            .scaleThreshold()
            .domain([18, 22, 26, 28, 30, 32])
            .range([
              "#0087bd",
              "#009698",
              "#008000",
              "#eed202",
              "#ff4500",
              "#ff0800",
            ]),
        },
        simple_window: {
        },
        co2: {
          unit: "ppm",
          precision: 0,
          length: 4,
          colorScale: d3
            .scaleThreshold()
            .domain([450, 600, 800, 1000, 1200])
            .range([
              "#0087bd",
              "#008000",
              "#eed202",
              "#ff4500",
              "#ff0800",
              "#ff0000",
            ]),
        },
      };
      // FIXME: sensorClass should be defined once and have internal split between general and detailed
      // FIXME: sensorClass should have indicator if it's numerical value or boolean
      function formatSensorValue(value, sensorClass, sensorType) {
        if (sensorType == "g") sensorClasses=sensorClassesG;
        else sensorClasses=sensorClassesD;
        if (sensorClass === "simple_window") {
          return value ? " OPEN " : "CLOSED";
        }
        else if (sensorClass === "temp_sun" || sensorClass === "temp_inside" || sensorClass === "temp_outside"|| sensorClass === "co2") {
          if (value == null) return "–--";
          const { unit, precision, length } = sensorClasses[sensorClass];
          return `${value.toFixed(precision).padStart(length, " ")}${unit}`;
        }
      }
      function getSensorColor(value, sensorClass, sensorType) {
        if (sensorType == "g") sensorClasses=sensorClassesG;
        else sensorClasses=sensorClassesD;
        if (sensorClass === "simple_window") {
          if (value===true) return "#ff4500";
          if (value===false) return "#008000";
          return "#000000";
        }
        else if (sensorClass === "temp_sun" || sensorClass === "temp_inside" || sensorClass === "temp_outside"|| sensorClass === "co2") {
          if (value == null) return "#000000"; 
          const { colorScale, precision }  = sensorClasses[sensorClass];
          return colorScale(value.toFixed(precision));
        }
      }
      function mockHomeAssistantResponse() {
        const data = {};
        for (const k in sensorDefs) {
          if (!sensorDefs.hasOwnProperty(k)) continue;
          data[k] = +(5 + Math.random() * 20).toFixed(1);
        }
        return data;
      }

      

      const svg = d3.select("#floorplan");
      const viewport = svg.select("#viewport");

      d3.json("/sensorDefs.json").then((data) => {
        sensorDefs = data;
        d3.xml("/floorplan.svg")
          .then((xml) => {
            const imported = xml.documentElement.cloneNode(true);
            imported.removeAttribute("width");
            imported.removeAttribute("height");

            Array.from(imported.childNodes).forEach((node) => {
              if (node.nodeType === 1) {
                viewport.node().appendChild(node.cloneNode(true));
              }
            });

            const sensorsG = viewport.append("g").attr("class", "sensors");

            const sensorGroups = sensorsG
              .selectAll("g.sensor")
              .data(Object.values(sensorDefs))
              .enter()
              .append("g")
              .attr("class", (d) => "sensor sensor-"+d.type+" sensor-" + d.class)
              .attr("id", (d) => d.id)
              .attr("transform", (d) => {
                const [x, y] = d.coords;
                return `translate(${x},${y})`;
              })
              .attr("data-sensor-id", (d) => d.data_id)
              .attr("data-sensor-class", (d) => d.class);

            sensorGroups
              .append("text")
              .attr("class", "sensor-value")
              .attr("x", 0)
              .attr("y", 0)
              .text("…");
            // FIXME: better way of handling initial group visibility
            showGeneralSensors();
            //showDetailedSensors();

            MOCK=false; // TODO: make it more configurable
            async function refreshSensors() {
              try {
                const response = MOCK ? mockHomeAssistantResponse : await fetch('/sensorValues.json');
                if (!response.ok) throw new Error(response.statusText);
                const data = await response.json();
                sensorsG
                  .selectAll("g.sensor")
                  .data(Object.values(sensorDefs))
                  .select("text.sensor-value")
                  .text(d => formatSensorValue(data[d.data_id], d.class, d.type))
                  .attr("fill", d => getSensorColor(data[d.data_id], d.class, d.type));
              } catch (e) {
                console.error('Failed to fetch sensor data:', e);
              }
            }
            refreshSensors();
            setInterval(refreshSensors, 60*1000);
          })
          .catch((err) => {
            console.error("Error loading floorplan.svg:", err);
          });
      });

      function showDetailedSensors() {
        d3.selectAll("g.sensor-g").attr("display", "none");
        d3.selectAll("g.sensor-d").attr("display", null);
      }
      function showGeneralSensors() {
        d3.selectAll("g.sensor-g").attr("display", null);
        d3.selectAll("g.sensor-d").attr("display", "none");
      }

      showDetailedSensors();

      svg.call(
        d3
          .zoom()
          .scaleExtent([1, 6])
          .on("zoom", ({ transform }) => {
            viewport.attr("transform", transform);
            const k = transform.k;
            const threshold = 2; // zoom scale threshold

            if (k > threshold) {
              // hide general sensors, show detailed
              showDetailedSensors();
            } else {
              // show general sensors, hide detailed
              showGeneralSensors();
            }
          })
      );
    </script>
  </body>
</html>
